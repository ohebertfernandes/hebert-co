<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS T√°tico: Hebert & Co. | Do Zero ao Imp√©rio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- Chosen Palette: Executive Gold & Slate -->
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; color: #1E293B; }
        h1, h2, h3, h4, .serif { font-family: 'Playfair Display', serif; }
        
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            height: 300px;
            max-height: 400px;
        }

        /* Checkbox Styling Logic */
        .checkbox-wrapper input:checked + div {
            background-color: #F1F5F9; /* Slate-100 */
            border-color: #64748B; /* Slate-500 */
            text-decoration: line-through;
            color: #94A3B8; /* Slate-400 */
        }

        .checkbox-wrapper input:checked + div .check-box-square {
            background-color: #475569; /* Slate-600 */
            border-color: #475569;
        }

        .checkbox-wrapper input:checked + div .check-icon {
            opacity: 1;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94A3B8; }

        .nav-item.active {
            background-color: #1E293B;
            color: #F8FAFC;
            border-left: 4px solid #B45309;
        }

        /* Animation for number updates */
        .number-bump {
            animation: bump 0.3s ease-out;
        }
        @keyframes bump {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); color: #059669; }
            100% { transform: scale(1); }
        }

        /* Modal Transitions */
        .modal {
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease-in-out;
        }
        .modal.open {
            opacity: 1;
            visibility: visible;
        }
        .modal.open .modal-content {
            transform: scale(1);
        }
        .modal-content {
            transform: scale(0.95);
            transition: all 0.3s ease-in-out;
        }

        /* Login Overlay Transition */
        #login-overlay {
            transition: opacity 0.5s ease-in-out, visibility 0.5s;
        }
        #login-overlay.hidden-overlay {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden relative">

    <!-- LOGIN OVERLAY -->
    <div id="login-overlay" class="absolute inset-0 z-50 bg-[#0F172A] flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white rounded-lg shadow-2xl overflow-hidden border border-gray-800">
            <div class="bg-amber-500 h-2 w-full"></div>
            <div class="p-8">
                <div class="text-center mb-8">
                    <div class="w-12 h-12 bg-slate-900 text-white flex items-center justify-center font-serif font-bold text-2xl rounded-sm mx-auto mb-4">H</div>
                    <h2 class="serif text-3xl font-bold text-slate-900">Hebert & Co.</h2>
                    <p class="text-xs uppercase tracking-[0.2em] text-amber-700 font-semibold mt-1">Acesso Restrito</p>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">E-mail</label>
                        <input type="email" id="login-email" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-md focus:outline-none focus:border-amber-500 text-slate-800 transition-colors" placeholder="seu@email.com">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Senha</label>
                        <input type="password" id="login-password" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-md focus:outline-none focus:border-amber-500 text-slate-800 transition-colors" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    
                    <p id="login-error" class="text-red-500 text-xs text-center min-h-[16px]"></p>

                    <button id="btn-login" class="w-full py-3 bg-slate-900 text-white font-bold uppercase tracking-widest rounded-md hover:bg-slate-800 transition-colors shadow-lg">
                        Entrar
                    </button>
                    
                    <div class="relative flex py-2 items-center">
                        <div class="flex-grow border-t border-gray-200"></div>
                        <span class="flex-shrink-0 mx-4 text-gray-400 text-xs">OU</span>
                        <div class="flex-grow border-t border-gray-200"></div>
                    </div>

                    <button id="btn-signup" class="w-full py-3 bg-white border border-slate-300 text-slate-700 font-bold uppercase tracking-widest rounded-md hover:bg-slate-50 transition-colors">
                        Criar Conta
                    </button>
                </div>
            </div>
            <div class="bg-slate-50 px-8 py-4 text-center border-t border-slate-100">
                <p class="text-xs text-slate-400">Sistema Seguro ‚Ä¢ Firebase Auth</p>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 h-16 flex-none z-20 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 h-full flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-slate-900 text-white flex items-center justify-center font-serif font-bold text-xl rounded-sm">H</div>
                <div>
                    <h1 class="font-serif font-bold text-lg tracking-wide text-slate-900 leading-none">HEBERT & CO.</h1>
                    <p class="text-[10px] uppercase tracking-[0.2em] text-amber-700 font-semibold">GPS T√°tico 2025</p>
                </div>
            </div>
            <div class="hidden md:flex items-center gap-6 text-sm">
                <div class="flex flex-col items-end">
                    <span class="text-xs text-slate-500 uppercase">Meta Final (Nov)</span>
                    <span class="font-bold text-emerald-700">R$ 150.000,00</span>
                </div>
                <div class="h-8 w-px bg-gray-200"></div>
                <div class="flex flex-col items-end">
                    <span class="text-xs text-slate-500 uppercase">Caixa Acumulado (Alvo)</span>
                    <span id="global-cash-display" class="font-bold text-amber-700">R$ 0 / R$ 48.840</span>
                </div>
                <div class="h-8 w-px bg-gray-200"></div>
                
                <!-- Auth Status & Logout -->
                <div class="flex items-center gap-4">
                    <div id="auth-status" class="flex items-center gap-2 text-xs text-slate-400">
                        <div class="w-2 h-2 rounded-full bg-gray-300"></div>
                        <span id="user-email-display">Conectando...</span>
                    </div>
                    <button id="btn-logout" class="text-xs font-bold text-slate-500 hover:text-red-600 uppercase tracking-wider hidden">
                        Sair
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <!-- Sidebar Navigation (Months) -->
        <nav class="w-20 md:w-64 bg-white border-r border-gray-200 flex-none overflow-y-auto flex flex-col">
            <div class="p-4 border-b border-gray-100">
                <h3 class="hidden md:block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Cronograma</h3>
                <p class="md:hidden text-center text-xs font-bold text-slate-400">M√äS</p>
            </div>
            <div id="month-nav" class="flex-1">
                <!-- Nav items generated by JS -->
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-y-auto p-4 md:p-8 bg-[#F8FAFC] relative">
            
            <div class="max-w-6xl mx-auto space-y-8">
                
                <!-- Section 1: Strategic Context (Intro Paragraph) -->
                <section class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-amber-600">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                        <div>
                            <span id="current-phase-badge" class="inline-block px-3 py-1 bg-amber-100 text-amber-800 text-xs font-bold uppercase tracking-wider rounded-full mb-2">Fase 1</span>
                            <h2 id="month-title" class="serif text-3xl font-bold text-slate-900">Janeiro: Tra√ß√£o & Valida√ß√£o</h2>
                        </div>
                        <div class="text-right hidden md:block w-1/3">
                            <div class="flex justify-between items-end mb-1">
                                <p class="text-xs text-slate-500 uppercase">Progresso da Meta (Vendas)</p>
                                <p id="progress-text" class="text-xs font-bold text-emerald-600">0%</p>
                            </div>
                            <div class="w-full h-3 bg-gray-100 rounded-full overflow-hidden">
                                <div id="progress-bar" class="h-full bg-emerald-500 w-0 transition-all duration-500"></div>
                            </div>
                        </div>
                    </div>
                    <p id="month-desc" class="text-slate-600 leading-relaxed mb-6">
                        Este √© o momento zero. O foco n√£o √© lucro, √© movimento. Voc√™ validar√° a oferta e gerar√° o primeiro caixa sem gastar 1 centavo, usando networking e parceiros comissionados.
                    </p>
                    
                    <!-- NEW STRATEGY BUTTON -->
                    <button onclick="openStrategyModal()" class="group flex items-center gap-3 px-5 py-3 bg-slate-800 hover:bg-slate-700 text-white rounded-md transition-all shadow-md active:scale-95">
                        <span class="text-lg">üìú</span>
                        <div class="text-left">
                            <p class="text-[10px] uppercase tracking-widest text-slate-400 font-bold group-hover:text-amber-400 transition-colors">Plano de Guerra</p>
                            <p class="text-sm font-bold">Ver Estrat√©gia do M√™s</p>
                        </div>
                        <span class="ml-auto text-slate-400 group-hover:translate-x-1 transition-transform">‚Üí</span>
                    </button>
                </section>

                <!-- Sales Register (Caixa Registradora) -->
                <section class="bg-slate-900 text-white p-6 rounded-lg shadow-lg border border-slate-800">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-emerald-600 rounded-full flex items-center justify-center text-2xl shadow-lg border border-emerald-400">
                                üí∞
                            </div>
                            <div>
                                <h3 class="font-serif font-bold text-lg">Registrar Venda Real</h3>
                                <p class="text-slate-400 text-xs">Adicione vendas manualmente. Dados salvos na nuvem.</p>
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-3">
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 text-sm">R$</span>
                                <input type="number" id="sale-input" value="160" class="w-24 bg-slate-800 border border-slate-700 rounded-md py-2 pl-8 pr-3 text-sm focus:outline-none focus:border-emerald-500 transition-colors text-white" placeholder="Valor">
                            </div>
                            <button onclick="addSale()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-2 rounded-md text-sm font-bold uppercase tracking-wider transition-all transform active:scale-95 shadow-lg border-b-2 border-emerald-800">
                                + Adicionar
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Section 2: Financial Dashboard for the Month -->
                <section class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-100">
                        <p class="text-xs text-slate-400 uppercase font-bold tracking-wider">Vendas (Real / Meta)</p>
                        <p id="stat-sales" class="text-2xl font-bold text-slate-900 mt-1">0 / 20 un.</p>
                        <p class="text-xs text-slate-500 mt-2">Foco: Volume</p>
                    </div>
                    <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-100">
                        <p class="text-xs text-slate-400 uppercase font-bold tracking-wider">Faturamento (Real / Meta)</p>
                        <p id="stat-revenue" class="text-2xl font-bold text-slate-900 mt-1">R$ 0 / R$ 3.200</p>
                        <p class="text-xs text-emerald-600 mt-2 font-medium">Margem Est: R$ 60/un</p>
                    </div>
                    <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-100">
                        <p class="text-xs text-slate-400 uppercase font-bold tracking-wider">Reinvestimento (Ads)</p>
                        <p id="stat-ads" class="text-2xl font-bold text-amber-600 mt-1">R$ 0</p>
                        <p class="text-xs text-slate-500 mt-2">Calculado na Meta</p>
                    </div>
                    <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-100 bg-slate-50">
                        <p class="text-xs text-slate-400 uppercase font-bold tracking-wider">Lucro Gerado (M√™s)</p>
                        <p id="stat-profit-real" class="text-2xl font-bold text-emerald-600 mt-1">R$ 0</p>
                        <p class="text-xs text-slate-400 mt-2 font-medium">Baseado em R$ 60/un</p>
                    </div>
                </section>

                <!-- Section 3: The Operational Checklist -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    
                    <!-- Checklist Column -->
                    <section class="lg:col-span-2 space-y-6">
                        <div class="flex items-center justify-between">
                            <h3 class="serif text-xl font-bold text-slate-800">Checklist de Execu√ß√£o</h3>
                            <button onclick="resetChecklist()" class="text-xs text-slate-400 hover:text-amber-600 underline">Resetar Tarefas</button>
                        </div>

                        <!-- NEW: Task Progress Bar -->
                        <div class="bg-white p-4 rounded-md border border-gray-200 shadow-sm">
                            <div class="flex justify-between items-end mb-2">
                                <span class="text-xs font-bold text-slate-500 uppercase tracking-wider">Progresso das Tarefas</span>
                                <span id="task-progress-text" class="text-xs font-bold text-slate-700">0/0 Conclu√≠das</span>
                            </div>
                            <div class="w-full h-2.5 bg-gray-100 rounded-full overflow-hidden">
                                <div id="task-progress-bar" class="h-full bg-slate-600 w-0 transition-all duration-500"></div>
                            </div>
                        </div>
                        
                        <div id="checklist-container" class="space-y-3">
                            <!-- Checklist items injected via JS -->
                        </div>

                        <div class="bg-amber-50 border border-amber-100 p-4 rounded-md mt-6">
                            <h4 class="text-sm font-bold text-amber-800 uppercase mb-1">üí° Dica do Estrategista</h4>
                            <p id="month-tip" class="text-sm text-amber-900 opacity-90">
                                Para vender sem estoque, use a escassez real. Diga "Consegui pegar apenas 5 unidades hoje" para o seu cliente. N√£o minta, mas use o limite log√≠stico a seu favor.
                            </p>
                        </div>
                    </section>

                    <!-- Monthly Analysis Column -->
                    <section class="space-y-8">
                        
                        <!-- Mini Chart: Cumulative Cash Goal -->
                        <div class="bg-slate-900 p-6 rounded-lg shadow-md text-white border-t-4 border-emerald-500">
                            <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-2">Caixa Acumulado (Simulado)</h3>
                            <div class="flex flex-col mb-4">
                                <span class="text-xs text-slate-400">Total Acumulado (Todas as Fases)</span>
                                <span id="stat-cash" class="text-3xl font-serif font-bold text-emerald-400">R$ 0</span>
                            </div>
                            <div class="w-full bg-slate-700 h-1.5 rounded-full overflow-hidden">
                                <div id="cash-bar" class="bg-emerald-500 h-full w-[0%]" style="transition: width 1s ease;"></div>
                            </div>
                            <p class="text-[10px] text-slate-400 mt-2 text-right">Meta Final (Out): R$ 48.840</p>
                        </div>

                        <!-- Mini Chart: Where the Money Goes -->
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-100">
                            <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4">Destino (Planejado)</h3>
                            <div class="chart-container" style="height: 200px;">
                                <canvas id="monthlyChart"></canvas>
                            </div>
                        </div>

                    </section>
                </div>

                <!-- Section 4: The Big Picture (Yearly Trajectory) -->
                <section class="bg-white p-6 md:p-8 rounded-lg shadow-sm border-t border-gray-100 mt-8">
                    <div class="mb-6">
                        <h3 class="serif text-2xl font-bold text-slate-800">O Efeito Bola de Neve ‚ùÑÔ∏è</h3>
                        <p class="text-slate-500 text-sm mt-1">
                            Acompanhe como o reinvestimento de 20% em tr√°fego (linha laranja) acelera o faturamento (barras) e o ac√∫mulo de caixa (linha verde) para o lan√ßamento.
                        </p>
                    </div>
                    <div class="chart-container" style="height: 350px;">
                        <canvas id="yearlyChart"></canvas>
                    </div>
                </section>

            </div>
        </main>
    </div>

    <!-- STRATEGY MODAL -->
    <div id="strategy-modal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm" onclick="closeStrategyModal()"></div>
        <div class="modal-content bg-white w-full max-w-2xl max-h-[85vh] overflow-y-auto rounded-lg shadow-2xl relative z-10 flex flex-col">
            <!-- Modal Header -->
            <div class="p-6 border-b border-gray-100 bg-slate-50 sticky top-0 z-10">
                <div class="flex justify-between items-start">
                    <div>
                        <span id="modal-phase" class="text-[10px] font-bold uppercase tracking-widest text-amber-600 bg-amber-100 px-2 py-1 rounded-sm">Fase 1</span>
                        <h3 id="modal-title" class="serif text-2xl font-bold text-slate-900 mt-2">Janeiro: Estrat√©gia Detalhada</h3>
                    </div>
                    <button onclick="closeStrategyModal()" class="text-slate-400 hover:text-slate-900 transition-colors p-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            </div>
            
            <!-- Modal Body -->
            <div id="modal-body" class="p-6 md:p-8 space-y-6">
                <!-- Content injected via JS -->
            </div>

            <!-- Modal Footer -->
            <div class="p-6 border-t border-gray-100 bg-slate-50 text-center">
                <button onclick="closeStrategyModal()" class="px-6 py-2 bg-slate-900 text-white text-sm font-bold uppercase tracking-widest rounded hover:bg-slate-800 transition-colors">
                    Entendi, vou executar
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript Application Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE SETUP ---
        const manualConfig = {
            apiKey: "AIzaSyCSySol-gHnc32PKjDCHrOHi1RMwpmRnRw",
            authDomain: "hebertco-49807.firebaseapp.com",
            projectId: "hebertco-49807",
            storageBucket: "hebertco-49807.firebasestorage.app",
            messagingSenderId: "855091637140",
            appId: "1:855091637140:web:e402397aac9b345d33bd81"
        };

        // Priority to manual config since user provided it
        const firebaseConfig = manualConfig;

        let db = null;
        let auth = null;
        let user = null;
        const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'hebert-co';

        // DOM Elements for Auth
        const loginOverlay = document.getElementById('login-overlay');
        const loginEmailInput = document.getElementById('login-email');
        const loginPassInput = document.getElementById('login-password');
        const loginErrorMsg = document.getElementById('login-error');
        const btnLogin = document.getElementById('btn-login');
        const btnSignup = document.getElementById('btn-signup');
        const btnLogout = document.getElementById('btn-logout');
        const authStatusDot = document.querySelector('#auth-status div');
        const authStatusText = document.getElementById('user-email-display');

        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Auth Listener
                onAuthStateChanged(auth, (u) => {
                    user = u;
                    if (user) {
                        // User is signed in
                        loginOverlay.classList.add('hidden-overlay');
                        btnLogout.classList.remove('hidden');
                        authStatusDot.className = "w-2 h-2 rounded-full bg-emerald-500";
                        authStatusText.innerText = user.email;
                        authStatusText.className = "text-emerald-600 font-bold";
                        loadData();
                    } else {
                        // User is signed out
                        loginOverlay.classList.remove('hidden-overlay');
                        btnLogout.classList.add('hidden');
                        authStatusDot.className = "w-2 h-2 rounded-full bg-slate-300";
                        authStatusText.innerText = "Aguardando Login";
                        authStatusText.className = "text-slate-400";
                        // Reset data display to zero for safety
                        globalActualCash = 0;
                        appData.forEach(m => { m.actual = {sales:0, revenue:0, profit:0}; m.tasks.forEach(t => t.done = false); });
                        window.loadMonth(0);
                        window.updateGlobalHeader();
                    }
                });

            } catch (e) {
                console.error("Firebase init error:", e);
                loginErrorMsg.innerText = "Erro ao conectar com servidor.";
            }
        }

        // --- AUTH FUNCTIONS ---
        async function handleLogin() {
            const email = loginEmailInput.value;
            const password = loginPassInput.value;
            loginErrorMsg.innerText = "";

            if(!email || !password) {
                loginErrorMsg.innerText = "Preencha e-mail e senha.";
                return;
            }

            try {
                btnLogin.innerText = "Entrando...";
                await signInWithEmailAndPassword(auth, email, password);
                // Success handled by onAuthStateChanged
            } catch (error) {
                console.error(error);
                loginErrorMsg.innerText = "E-mail ou senha incorretos.";
            } finally {
                btnLogin.innerText = "ENTRAR";
            }
        }

        async function handleSignup() {
            const email = loginEmailInput.value;
            const password = loginPassInput.value;
            loginErrorMsg.innerText = "";

            if(!email || !password) {
                loginErrorMsg.innerText = "Preencha e-mail e senha.";
                return;
            }
            if(password.length < 6) {
                loginErrorMsg.innerText = "A senha deve ter no m√≠nimo 6 caracteres.";
                return;
            }

            try {
                btnSignup.innerText = "Criando...";
                await createUserWithEmailAndPassword(auth, email, password);
                // Success handled by onAuthStateChanged
            } catch (error) {
                console.error(error);
                if(error.code === 'auth/email-already-in-use') {
                    loginErrorMsg.innerText = "Este e-mail j√° est√° cadastrado.";
                } else {
                    loginErrorMsg.innerText = "Erro ao criar conta. Tente novamente.";
                }
            } finally {
                btnSignup.innerText = "CRIAR CONTA";
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error(error);
            }
        }

        // --- DATA SAVING & LOADING ---
        async function saveData() {
            if (!db || !user) return;
            
            authStatusText.innerText = "Salvando...";
            
            const savePayload = {
                actuals: appData.map(m => m.actual),
                tasks: appData.map(m => m.tasks.map(t => t.done)),
                lastUpdated: new Date().toISOString()
            };

            try {
                const userDocRef = doc(db, 'artifacts', appId, 'users', user.uid, 'app_data', 'gps_progress');
                await setDoc(userDocRef, savePayload, { merge: true });
                setTimeout(() => authStatusText.innerText = user.email, 800);
            } catch (e) {
                console.error("Save error:", e);
                authStatusText.innerText = "Erro ao Salvar";
            }
        }

        async function loadData() {
            if (!db || !user) return;

            try {
                const userDocRef = doc(db, 'artifacts', appId, 'users', user.uid, 'app_data', 'gps_progress');
                const docSnap = await getDoc(userDocRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    if (data.actuals) {
                        data.actuals.forEach((act, idx) => {
                            if (appData[idx]) appData[idx].actual = act;
                        });
                        globalActualCash = appData.reduce((sum, item) => sum + item.actual.profit, 0);
                    }

                    if (data.tasks) {
                        data.tasks.forEach((taskBooleans, idx) => {
                            if (appData[idx]) {
                                taskBooleans.forEach((done, tIdx) => {
                                    if (appData[idx].tasks[tIdx]) appData[idx].tasks[tIdx].done = done;
                                });
                            }
                        });
                    }

                    // Refresh UI
                    window.loadMonth(currentMonthIndex);
                    window.updateGlobalHeader();
                }
            } catch (e) {
                console.error("Load error:", e);
            }
        }

        // --- DATA STORE ---
        const appData = [
            {
                id: 0,
                month: 'Janeiro',
                phase: 'Fase 1: Tra√ß√£o Org√¢nica',
                focus: 'Venda no "Bra√ßo"',
                desc: 'M√™s de valida√ß√£o. Como n√£o tivemos lucro em dezembro, o investimento em an√∫ncios √© ZERO. Tudo depende do seu esfor√ßo no WhatsApp e Networking.',
                tip: 'N√£o venda o perfume, venda a oportunidade exclusiva. "Consegui um lote de 5 unidades".',
                stats: { sales: 20, revenue: 3200, profit: 1200, ads: 0, salary: 0, accumulated: 1200 },
                actual: { sales: 0, revenue: 0, profit: 0 },
                tasks: [
                    { text: 'Listar 50 contatos "quentes" no WhatsApp', done: false },
                    { text: 'Fechar 2 parcerias por comiss√£o (R$ 30/venda)', done: false },
                    { text: 'Postar Stories gerando escassez real', done: false },
                    { text: 'Separar R$ 1.200 de lucro no caixa (Base para Fev)', done: false }
                ],
                strategy: `
                    <div class="space-y-6">
                        <div class="bg-slate-50 p-4 border-l-4 border-slate-500 rounded-r-md">
                            <h4 class="font-bold text-slate-900 text-sm uppercase mb-1">Caixa Zero</h4>
                            <p class="text-sm text-slate-700">N√£o gaste nada em an√∫ncios. O lucro deste m√™s (R$ 1.200) vai financiar os an√∫ncios acumulados de Mar√ßo. Guarde cada centavo.</p>
                        </div>
                        <div class="bg-amber-50 p-4 border-l-4 border-amber-500 rounded-r-md">
                            <h4 class="font-bold text-amber-900 text-sm uppercase mb-1">A√ß√£o T√°tica</h4>
                            <p class="text-sm text-amber-800">Abordagem 1 a 1 no WhatsApp. Script: "Fulano, consegui 5 unidades de um perfume incr√≠vel. Lembrei de voc√™."</p>
                        </div>
                    </div>
                `
            },
            {
                id: 1,
                month: 'Fevereiro',
                phase: 'Fase 2: Represa Estrat√©gica',
                focus: 'Ac√∫mulo de Verba',
                desc: 'Decis√£o Estrat√©gica: N√£o investiremos os R$ 240 agora. Vamos segurar esse valor para somar com o lucro de Fev e fazer um lan√ßamento mais forte da Loja em Mar√ßo.',
                tip: 'Foque totalmente em indica√ß√µes e org√¢nico para maximizar o lucro que ser√° reinvestido m√™s que vem.',
                stats: { sales: 35, revenue: 5600, profit: 2100, ads: 0, salary: 0, accumulated: 3300 },
                actual: { sales: 0, revenue: 0, profit: 0 },
                tasks: [
                    { text: 'Guardar verba de Ads (R$ 240) para Mar√ßo', done: false },
                    { text: 'Contatar os 20 clientes de Jan (P√≥s-venda)', done: false },
                    { text: 'Montar kits de Decants (3x 5ml)', done: false },
                    { text: 'Validar lucro acumulado de R$ 3.300 (Caixa cheio)', done: false }
                ],
                strategy: `
                    <div class="space-y-6">
                        <div class="bg-blue-50 p-4 border-l-4 border-blue-500 rounded-r-md">
                            <h4 class="font-bold text-blue-900 text-sm uppercase mb-1">Efeito Estilingue</h4>
                            <p class="text-sm text-blue-800">Ao n√£o gastar em an√∫ncios agora, juntamos for√ßa. Em Mar√ßo teremos verba dupla (Jan + Fev) para inaugurar a loja com tr√°fego pesado.</p>
                        </div>
                        <div class="bg-emerald-50 p-4 border-l-4 border-emerald-500 rounded-r-md">
                            <h4 class="font-bold text-emerald-900 text-sm uppercase mb-1">Campanha de Indica√ß√£o</h4>
                            <p class="text-sm text-emerald-800">Como n√£o tem an√∫ncio, sua fonte de leads √© a indica√ß√£o. Ofere√ßa 10% de desconto se indicarem um amigo.</p>
                        </div>
                    </div>
                `
            },
            {
                id: 2,
                month: 'Mar√ßo',
                phase: 'Fase 3: Digitaliza√ß√£o',
                focus: 'Loja & Tr√°fego Duplo',
                desc: 'Inaugura√ß√£o da Loja Virtual com "Tiro de Canh√£o". Investimento acumulado de R$ 660 (Jan + Fev) para validar r√°pido.',
                tip: 'Com R$ 660, voc√™ consegue alcan√ßar cerca de 20.000 pessoas na sua cidade. Prepare o direct.',
                stats: { sales: 50, revenue: 8000, profit: 3000, ads: 660, salary: 0, accumulated: 5640 },
                actual: { sales: 0, revenue: 0, profit: 0 },
                tasks: [
                    { text: 'Criar loja na Yampi/Cartpanda/Shopify', done: false },
                    { text: 'Investir R$ 660 em Ads (Acumulado Jan+Fev)', done: false },
                    { text: 'Gravar v√≠deo "User Generated Content" do produto', done: false },
                    { text: 'Manter Pro-labore ZERO (Foco no caixa)', done: false }
                ],
                strategy: `
                    <div class="space-y-6">
                        <div class="bg-amber-50 p-4 border-l-4 border-amber-500 rounded-r-md">
                            <h4 class="font-bold text-amber-900 text-sm uppercase mb-1">Investimento Turbo (R$ 660)</h4>
                            <p class="text-sm text-amber-800">
                                <strong>Origem:</strong> R$ 240 (Jan) + R$ 420 (Fev).<br>
                                Use essa verba maior para testar 3 criativos diferentes de uma vez e descobrir qual vende mais.
                            </p>
                        </div>
                        <div class="bg-blue-50 p-4 border-l-4 border-blue-500 rounded-r-md">
                            <h4 class="font-bold text-blue-900 text-sm uppercase mb-1">Estrat√©gia: Convers√£o</h4>
                            <p class="text-sm text-blue-800">Agora com verba decente e site pronto, configure o Pixel do Facebook e foque em campanhas de "Convers√£o" ou "Initiate Checkout".</p>
                        </div>
                    </div>
                `
            },
            {
                id: 3,
                month: 'Abril',
                phase: 'Fase 4: Escala Inicial',
                focus: 'Prepara√ß√£o M√£es',
                desc: 'Investimento de R$ 600 (20% do lucro de Mar). Prepara√ß√£o de estoque feminino.',
                tip: 'Use os R$ 600 para criar p√∫blicos de remarketing (quem viu, mas n√£o comprou).',
                stats: { sales: 70, revenue: 11200, profit: 4200, ads: 600, salary: 0, accumulated: 9240 },
                actual: { sales: 0, revenue: 0, profit: 0 },
                tasks: [
                    { text: 'Investir R$ 600 em Ads (Origem: Lucro Mar)', done: false },
                    { text: 'Estoque de perfumes femininos (Good Girl/La Vie)', done: false },
                    { text: 'Campanha "Antecipe o Presente da M√£e"', done: false }
                ],
                strategy: `
                    <div class="space-y-6">
                        <div class="bg-pink-50 p-4 border-l-4 border-pink-500 rounded-r-md">
                            <h4 class="font-bold text-pink-900 text-sm uppercase mb-1">Estrat√©gia: Foco Feminino</h4>
                            <p class="text-sm text-pink-800">Abril √© prepara√ß√£o. O Dia das M√£es √© a segunda melhor data do ano. Garanta acesso a perfumes femininos de alta sa√≠da.</p>
                        </div>
                        <div class="bg-slate-50 p-4 border-l-4 border-slate-500 rounded-r-md">
                            <h4 class="font-bold text-slate-900 text-sm uppercase mb-1">A√ß√£o T√°tica: Antecipa√ß√£o</h4>
                            <p class="text-sm text-slate-700">Avise a lista VIP: "Garanta o presente da sua m√£e antes que acabe". Aumente o or√ßamento de tr√°fego gradualmente.</p>
                        </div>
                    </div>
                `
            },
            {
                id: 4,
                month: 'Maio',
                phase: 'Fase 4: Escala (Pico 1)',
                focus: 'Dia das M√£es',
                desc: 'Investimento de R$ 840 (20% do lucro de Abr). Primeiro grande pico de vendas.',
                tip: 'Entregue r√°pido. No Dia das M√£es, o atraso √© imperdo√°vel.',
                stats: { sales: 110, revenue: 17600, profit: 6600, ads: 840, salary: 0, accumulated: 15000 },
                actual: { sales: 0, revenue: 0, profit: 0 },
                tasks: [
                    { text: 'Investir R$ 840 em Ads (Origem: Lucro Abr)', done: false },
                    { text: 'Contratar motoboy extra para semana das M√£es', done: false },
                    { text: 'Guardar TODO o excedente (Pro-labore ZERO)', done: false }
                ],
                strategy: `
                    <div class="space-y-6">
                        <div class="bg-red-50 p-4 border-l-4 border-red-500 rounded-r-md">
                            <h4 class="font-bold text-red-900 text-sm uppercase mb-1">Matem√°tica do Investimento</h4>
                            <p class="text-sm text-red-800">Lucro Abr: R$ 4.200 ‚Üí 20% = <strong>R$ 840 de Ads</strong>. Concentre essa verba nos primeiros 10 dias do m√™s.</p>
                        </div>
                        <div class="bg-emerald-50 p-4 border-l-4 border-emerald-500 rounded-r-md">
                            <h4 class="font-bold text-emerald-900 text-sm uppercase mb-1">Marco Financeiro</h4>
                            <p class="text-sm text-emerald-800">Se batermos a meta, fecharemos o m√™s com R$ 15.000 em caixa acumulado.</p>
                        </div>
                    </div>
                `
            },
            {
                id: 5,
                month: 'Junho',
                phase: 'Fase 4: Escala (Pico 2)',
                focus: 'Dia dos Namorados',
                desc: 'Investimento recorde de R$ 1.320 (20% do lucro de Mai). Foco em Kits de Casal.',
                tip: 'Venda o "Combo Amor" (1 Masc + 1 Fem) para aumentar o ticket m√©dio.',
                stats: { sales: 120, revenue: 19200, profit: 7200, ads: 1320, salary: 0, accumulated: 20880 },
                actual: { sales: 0, revenue: 0, profit: 0 },
                tasks: [
                    { text: 'Investir R$ 1.320 em Ads (Origem: Lucro Mai)', done: false },
                    { text: 'Criar oferta "Combo Casal" (Desconto progressivo)', done: false },
                    { text: 'Resistir √† tenta√ß√£o: Pro-labore ZERO', done: false }
                ],
                strategy: `
                    <div class="space-y-6">
                        <div class="bg-purple-50 p-4 border-l-4 border-purple-500 rounded-r-md">
                            <h4 class="font-bold text-purple-900 text-sm uppercase mb-1">Matem√°tica do Investimento</h4>
                            <p class="text-sm text-purple-800">Lucro Mai: R$ 6.600 ‚Üí 20% = <strong>R$ 1.320 de Ads</strong>. Verba agressiva para vender kits duplos.</p>
                        </div>
                        <div class="bg-amber-50 p-4 border-l-4 border-amber-500 rounded-r-md">
                            <h4 class="font-bold text-amber-900 text-sm uppercase mb-1">Oferta</h4>
                            <p class="text-sm text-amber-800">"Combo Amor": Compre o dele e leve o dela com 15% OFF.</p>
                        </div>
                    </div>
                `
            },
            {
                id: 6,
                month: 'Julho',
                phase: 'Fase 5: Pivot',
                focus: 'Aumento Ticket',
                desc: 'Investimento de R$ 1.440 (20% do lucro de Jun). M√™s de estabiliza√ß√£o p√≥s-datas comemorativas.',
                tip: 'Analise os dados do semestre. Qual perfume vendeu mais? Foque nele.',
                stats: { sales: 140, revenue: 22400, profit: 8400, ads: 1440, salary: 0, accumulated: 27840 },
                actual: { sales: 0, revenue: 0, profit: 0 },
                tasks: [
                    { text: 'Investir R$ 1.440 em Ads (Origem: Lucro Jun)', done: false },
                    { text: 'Pesquisa inicial de fornecedores (Frascos/Tampas)', done: false },
                    { text: '√öltimo m√™s sem sal√°rio!', done: false }
                ],
                strategy: `
                    <div class="space-y-6">
                        <div class="bg-blue-50 p-4 border-l-4 border-blue-500 rounded-r-md">
                            <h4 class="font-bold text-blue-900 text-sm uppercase mb-1">Matem√°tica do Investimento</h4>
                            <p class="text-sm text-blue-800">Lucro Jun: R$ 7.200 ‚Üí 20% = <strong>R$ 1.440 de Ads</strong>. Manter o ritmo mesmo sem data comemorativa.</p>
                        </div>
                        <div class="bg-slate-50 p-4 border-l-4 border-slate-500 rounded-r-md">
                            <h4 class="font-bold text-slate-900 text-sm uppercase mb-1">Pesquisa</h4>
                            <p class="text-sm text-slate-700">Comece a or√ßar frascos e tampas. O caixa acumulado j√° est√° em R$ 27.840.</p>
                        </div>
                    </div>
                `
            },
            {
                id: 7,
                month: 'Agosto',
                phase: 'Fase 5: Pivot (Pico 3)',
                focus: 'Dia dos Pais',
                desc: 'Investimento de R$ 1.680 (20% do lucro de Jul). Primeiro m√™s de Pro-labore (R$ 1.000).',
                tip: 'Argumento: "Um perfume √† altura do sucesso do seu pai".',
                stats: { sales: 150, revenue: 24000, profit: 9000, ads: 1680, salary: 1000, accumulated: 34160 },
                actual: { sales: 0, revenue: 0, profit: 0 },
                tasks: [
                    { text: 'Investir R$ 1.680 em Ads (Origem: Lucro Jul)', done: false },
                    { text: 'Campanha "Pai Executivo" (Foco em Couro/Madeira)', done: false },
                    { text: 'Retirar 1¬∫ Pro-labore (R$ 1.000)', done: false }
                ],
                strategy: `
                    <div class="space-y-6">
                        <div class="bg-slate-800 p-4 border-l-4 border-amber-500 rounded-r-md">
                            <h4 class="font-bold text-amber-400 text-sm uppercase mb-1">Matem√°tica do Investimento</h4>
                            <p class="text-sm text-gray-300">Lucro Jul: R$ 8.400 ‚Üí 20% = <strong>R$ 1.680 de Ads</strong>. Foco total em p√∫blico masculino +40 anos.</p>
                        </div>
                        <div class="bg-emerald-50 p-4 border-l-4 border-emerald-500 rounded-r-md">
                            <h4 class="font-bold text-emerald-900 text-sm uppercase mb-1">Marco Pessoal</h4>
                            <p class="text-sm text-emerald-800">Parab√©ns! Primeiro sal√°rio de R$ 1.000 liberado. O caixa da empresa continua crescendo forte.</p>
                        </div>
                    </div>
                `
            },
            {
                id: 8,
                month: 'Setembro',
                phase: 'Fase 5: Produ√ß√£o',
                focus: 'Encomenda "The Chairman"',
                desc: 'Investimento de R$ 1.800 (20% do lucro de Ago). Momento de pagar a f√°brica.',
                tip: 'Pague √† vista para garantir prioridade na f√°brica. O Natal n√£o espera.',
                stats: { sales: 160, revenue: 25600, profit: 9600, ads: 1800, salary: 1000, accumulated: 40960 },
                actual: { sales: 0, revenue: 0, profit: 0 },
                tasks: [
                    { text: 'Investir R$ 1.800 em Ads (Origem: Lucro Ago)', done: false },
                    { text: 'Pagar produ√ß√£o do Lote 300un (R$ ~24k)', done: false },
                    { text: 'Finalizar design de r√≥tulos', done: false },
                    { text: 'Manter Pro-labore de R$ 1.000', done: false }
                ],
                strategy: `
                    <div class="space-y-6">
                        <div class="bg-slate-100 p-4 border-l-4 border-slate-900 rounded-r-md">
                            <h4 class="font-bold text-slate-900 text-sm uppercase mb-1">O Pedido da F√°brica</h4>
                            <p class="text-sm text-slate-700">Temos R$ 40.960 em caixa. Pagamos os R$ 24.000 da produ√ß√£o √† vista e ainda sobram R$ 16.000.</p>
                        </div>
                        <div class="bg-blue-50 p-4 border-l-4 border-blue-500 rounded-r-md">
                            <h4 class="font-bold text-blue-900 text-sm uppercase mb-1">Reinvestimento</h4>
                            <p class="text-sm text-blue-800">Lucro Ago: R$ 9.000 ‚Üí 20% = <strong>R$ 1.800 de Ads</strong>. Mantenha as vendas de revenda rodando.</p>
                        </div>
                    </div>
                `
            },
            {
                id: 9,
                month: 'Outubro',
                phase: 'Fase 6: Aquecimento',
                focus: 'Narrativa & Leads',
                desc: 'Investimento de R$ 1.920 (20% do lucro de Set). Foco total em captar leads para o lan√ßamento.',
                tip: 'Mostre bastidores. "Algo novo est√° chegando". Crie curiosidade.',
                stats: { sales: 180, revenue: 28800, profit: 10800, ads: 1920, salary: 1000, accumulated: 48840 },
                actual: { sales: 0, revenue: 0, profit: 0 },
                tasks: [
                    { text: 'Investir R$ 1.920 em Ads (Origem: Lucro Set)', done: false },
                    { text: 'Postar spoilers (Frasco, silhueta)', done: false },
                    { text: 'Criar Landing Page "Lista de Espera"', done: false },
                    { text: 'Manter Pro-labore de R$ 1.000', done: false }
                ],
                strategy: `
                    <div class="space-y-6">
                        <div class="bg-purple-50 p-4 border-l-4 border-purple-500 rounded-r-md">
                            <h4 class="font-bold text-purple-900 text-sm uppercase mb-1">Mudan√ßa de Tom</h4>
                            <p class="text-sm text-purple-800">Lucro Set: R$ 9.600 ‚Üí 20% = <strong>R$ 1.920 de Ads</strong>. Use esse dinheiro APENAS para captar leads para o Grupo VIP.</p>
                        </div>
                        <div class="bg-slate-50 p-4 border-l-4 border-slate-500 rounded-r-md">
                            <h4 class="font-bold text-slate-900 text-sm uppercase mb-1">Caixa Pr√©-Lan√ßamento</h4>
                            <p class="text-sm text-slate-700">Chegamos com <strong>R$ 48.840</strong> acumulados. A f√°brica est√° paga e temos muita gordura para a Black Friday.</p>
                        </div>
                    </div>
                `
            },
            {
                id: 10,
                month: 'Novembro',
                phase: 'Fase 6: O LAN√áAMENTO',
                focus: 'Black Friday & Marca Pr√≥pria',
                desc: 'O grande dia. Meta Audaciosa: R$ 150.000. Esgotar o Chairman e vender muito estoque de revenda no v√°cuo.',
                tip: 'A oferta √© Rei. "De R$ 389 por R$ 297 - Lote Fundador". Upsell com importados.',
                stats: { sales: 600, revenue: 150000, profit: 95000, ads: 20000, salary: 5000, accumulated: 118840 }, 
                actual: { sales: 0, revenue: 0, profit: 0 },
                tasks: [
                    { text: 'Investimento Massivo: R$ 20.000 (Caixa + Fluxo)', done: false },
                    { text: 'Abertura Antecipada para Grupo VIP (Ter√ßa)', done: false },
                    { text: 'Abertura Geral (Black Friday)', done: false },
                    { text: 'Meta: 300 Pr√≥prios + 300 Revenda', done: false },
                    { text: 'Sacar Pro-labore de R$ 5.000', done: false }
                ],
                strategy: `
                    <div class="space-y-6">
                        <div class="bg-amber-100 p-4 border-l-4 border-amber-600 rounded-r-md">
                            <h4 class="font-bold text-amber-900 text-sm uppercase mb-1">Meta Ouro: R$ 150k</h4>
                            <p class="text-sm text-amber-800">
                                N√£o vamos parar em 99k. Com R$ 20.000 de tr√°fego (recorde absoluto), vamos esgotar o The Chairman e usar o fluxo de clientes para limpar o estoque de revenda.
                            </p>
                        </div>
                        <div class="bg-red-50 p-4 border-l-4 border-red-500 rounded-r-md">
                            <h4 class="font-bold text-red-900 text-sm uppercase mb-1">Estrat√©gia de Upsell</h4>
                            <p class="text-sm text-red-800">"J√° garantiu sua assinatura (The Chairman)? Leve um importado para o dia a dia com 15% OFF". Aumente o ticket m√©dio.</p>
                        </div>
                        <div class="bg-emerald-50 p-4 border-l-4 border-emerald-500 rounded-r-md">
                            <h4 class="font-bold text-emerald-900 text-sm uppercase mb-1">O Resultado</h4>
                            <p class="text-sm text-emerald-800">Terminaremos o ano com mais de <strong>R$ 100.000 em caixa livre</strong>.</p>
                        </div>
                    </div>
                `
            }
        ];

        let currentMonthIndex = 0;
        let globalActualCash = 0;
        let monthlyChartInstance = null;
        let yearlyChartInstance = null;

        // --- DOM ELEMENTS ---
        const monthNav = document.getElementById('month-nav');
        const checklistContainer = document.getElementById('checklist-container');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const cashBar = document.getElementById('cash-bar');
        const taskProgressBar = document.getElementById('task-progress-bar');
        const taskProgressText = document.getElementById('task-progress-text');
        
        // Modal Elements
        const modal = document.getElementById('strategy-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalPhase = document.getElementById('modal-phase');
        const modalBody = document.getElementById('modal-body');

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            btnLogin.addEventListener('click', handleLogin);
            btnSignup.addEventListener('click', handleSignup);
            btnLogout.addEventListener('click', handleLogout);
            initFirebase();
            renderNav();
            loadMonth(0);
            renderYearlyChart();
            updateGlobalHeader();
        });

        // --- MODAL LOGIC ---
        window.openStrategyModal = () => {
            const data = appData[currentMonthIndex];
            modalTitle.innerText = `${data.month}: Estrat√©gia Detalhada`;
            modalPhase.innerText = data.phase;
            modalBody.innerHTML = data.strategy;
            modal.classList.add('open');
        }

        window.closeStrategyModal = () => {
            modal.classList.remove('open');
        }

        // Close on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeStrategyModal();
        });

        // --- LOGIC: ADD SALE ---
        window.addSale = () => {
            const input = document.getElementById('sale-input');
            const value = parseFloat(input.value);
            
            if (isNaN(value) || value <= 0) return;

            const currentData = appData[currentMonthIndex];
            
            // Update Monthly Actuals
            currentData.actual.sales += 1;
            currentData.actual.revenue += value;
            
            // Calculate Profit (Simplified: Revenue - Cost(100))
            const estimatedCost = 100;
            const marginalProfit = value - estimatedCost;
            currentData.actual.profit += marginalProfit;
            
            // Update Global Counter
            globalActualCash += marginalProfit;

            // Save to Firebase
            saveData();

            // Visual Updates
            updateDashboardNumbers();
            updateGlobalHeader();

            // Trigger Animation
            const els = ['stat-sales', 'stat-revenue', 'stat-profit-real'];
            els.forEach(id => {
                const el = document.getElementById(id);
                el.classList.remove('number-bump');
                void el.offsetWidth; // trigger reflow
                el.classList.add('number-bump');
            });
        }

        window.updateDashboardNumbers = () => {
            const data = appData[currentMonthIndex];
            
            // Update Text
            document.getElementById('stat-sales').innerText = `${data.actual.sales} / ${data.stats.sales} un.`;
            document.getElementById('stat-revenue').innerText = `R$ ${data.actual.revenue.toLocaleString('pt-BR')} / R$ ${data.stats.revenue.toLocaleString('pt-BR')}`;
            document.getElementById('stat-profit-real').innerText = `R$ ${data.actual.profit.toLocaleString('pt-BR')}`;
            
            // Update Progress Bar (Revenue Based)
            const pct = Math.min(100, Math.round((data.actual.revenue / data.stats.revenue) * 100));
            document.getElementById('progress-bar').style.width = `${pct}%`;
            document.getElementById('progress-text').innerText = `${pct}%`;

            // Update color based on success
            if(pct >= 100) {
                document.getElementById('progress-bar').classList.remove('bg-emerald-500');
                document.getElementById('progress-bar').classList.add('bg-amber-500'); // Gold for success
            }
        }

        window.updateGlobalHeader = () => {
            const targetCash = 48840; 
            const cashDisplay = document.getElementById('global-cash-display');
            cashDisplay.innerText = `R$ ${globalActualCash.toLocaleString('pt-BR')} / R$ ${targetCash.toLocaleString('pt-BR')}`;

            // Update Sidebar Cash Bar
            const cashDisplaySidebar = document.getElementById('stat-cash');
            if(cashDisplaySidebar) {
                cashDisplaySidebar.innerText = `R$ ${globalActualCash.toLocaleString('pt-BR')}`;
            }
            
            const cashPct = Math.min(100, (globalActualCash / targetCash) * 100);
            if(cashBar) {
                document.getElementById('cash-bar').style.width = `${cashPct}%`;
            }
        }

        // --- NEW: TASK PROGRESS LOGIC ---
        window.updateTaskProgress = () => {
             const inputs = checklistContainer.querySelectorAll('input[type="checkbox"]');
             const checked = checklistContainer.querySelectorAll('input[type="checkbox"]:checked');
             const count = checked.length;
             const total = inputs.length;
             const pct = total > 0 ? (count / total) * 100 : 0;
             
             // Update State
             inputs.forEach((input, index) => {
                 if(appData[currentMonthIndex].tasks[index]) {
                     appData[currentMonthIndex].tasks[index].done = input.checked;
                 }
             });

             saveData();
             
             taskProgressBar.style.width = `${pct}%`;
             taskProgressText.innerText = `${count}/${total} Conclu√≠das`;

             if(pct >= 100) {
                 taskProgressBar.classList.remove('bg-slate-600');
                 taskProgressBar.classList.add('bg-amber-500');
             } else {
                 taskProgressBar.classList.add('bg-slate-600');
                 taskProgressBar.classList.remove('bg-amber-500');
             }
        }


        // --- RENDERING ---
        window.renderNav = () => {
            monthNav.innerHTML = '';
            appData.forEach((data, index) => {
                const btn = document.createElement('button');
                btn.className = `nav-item w-full text-left p-4 border-b border-gray-100 hover:bg-slate-50 transition-colors ${index === 0 ? 'active' : ''}`;
                btn.onclick = () => loadMonth(index);
                btn.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-sm uppercase tracking-wide">${data.month.substring(0, 3)}</span>
                        ${index === 10 ? '<span class="text-[10px] bg-amber-100 text-amber-800 px-1 rounded">‚òÖ</span>' : ''}
                    </div>
                    <div class="text-[10px] text-slate-400 truncate mt-1">${data.focus}</div>
                `;
                monthNav.appendChild(btn);
            });
        }

        window.loadMonth = (index) => {
            currentMonthIndex = index;
            const data = appData[index];

            document.querySelectorAll('.nav-item').forEach((el, i) => {
                el.classList.toggle('active', i === index);
                if(i === index) {
                    el.classList.add('bg-slate-800', 'text-white', 'border-l-4', 'border-amber-600');
                    el.classList.remove('hover:bg-slate-50');
                } else {
                    el.classList.remove('bg-slate-800', 'text-white', 'border-l-4', 'border-amber-600');
                    el.classList.add('hover:bg-slate-50');
                }
            });

            document.getElementById('current-phase-badge').innerText = data.phase;
            document.getElementById('month-title').innerText = `${data.month}: ${data.focus}`;
            document.getElementById('month-desc').innerText = data.desc;
            document.getElementById('month-tip').innerText = data.tip;
            document.getElementById('stat-ads').innerText = `R$ ${data.stats.ads.toLocaleString('pt-BR')}`;
            // Removed stat-salary reference
            
            updateDashboardNumbers();
            renderChecklist(data.tasks);
            renderMonthlyChart(data.stats);
        }

        window.renderChecklist = (tasks) => {
            checklistContainer.innerHTML = '';
            tasks.forEach((taskObj, i) => {
                const id = `task-${currentMonthIndex}-${i}`;
                const div = document.createElement('div');
                div.className = 'checkbox-wrapper relative';
                const checkedAttr = taskObj.done ? 'checked' : '';
                
                div.innerHTML = `
                    <input type="checkbox" id="${id}" class="peer absolute w-full h-full opacity-0 cursor-pointer" onchange="updateTaskProgress()" ${checkedAttr}>
                    <div class="flex items-start gap-3 p-4 bg-white border border-gray-200 rounded-md transition-all duration-200 peer-hover:border-amber-300">
                        <div class="w-5 h-5 flex-none rounded border border-gray-300 flex items-center justify-center bg-white transition-colors peer-checked:bg-slate-600 peer-checked:border-slate-600 check-box-square">
                             <svg class="check-icon w-3 h-3 text-white opacity-0 transition-opacity" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                            </svg>
                        </div>
                        <label for="${id}" class="text-sm font-medium text-slate-700 select-none cursor-pointer flex-1">${taskObj.text}</label>
                    </div>
                `;
                checklistContainer.appendChild(div);
            });
            const inputs = checklistContainer.querySelectorAll('input[type="checkbox"]');
            const checked = checklistContainer.querySelectorAll('input[type="checkbox"]:checked');
            const pct = inputs.length > 0 ? (checked.length / inputs.length) * 100 : 0;
            taskProgressBar.style.width = `${pct}%`;
            taskProgressText.innerText = `${checked.length}/${inputs.length} Conclu√≠das`;
             if(pct >= 100) {
                 taskProgressBar.classList.remove('bg-slate-600');
                 taskProgressBar.classList.add('bg-amber-500');
             } else {
                 taskProgressBar.classList.add('bg-slate-600');
                 taskProgressBar.classList.remove('bg-amber-500');
             }
        }

        window.resetChecklist = () => {
             checklistContainer.querySelectorAll('input[type="checkbox"]').forEach(input => input.checked = false);
             updateTaskProgress();
        }

        // --- CHARTS ---
        window.renderMonthlyChart = (stats) => {
            const ctx = document.getElementById('monthlyChart').getContext('2d');
            
            const productCost = stats.sales * 100;
            const netCashToVault = stats.profit - stats.ads - stats.salary; 
            const displayVault = Math.max(0, netCashToVault);

            if (monthlyChartInstance) monthlyChartInstance.destroy();

            monthlyChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Custo Produto', 'Reinvest. Tr√°fego', 'Seu Pro-Labore', 'Caixa Empresa'],
                    datasets: [{
                        data: [productCost, stats.ads, stats.salary, displayVault],
                        backgroundColor: ['#CBD5E1', '#F59E0B', '#EF4444', '#059669'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed !== null) label += new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(context.parsed);
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        window.renderYearlyChart = () => {
            const ctx = document.getElementById('yearlyChart').getContext('2d');
            
            const labels = appData.map(d => d.month.substring(0, 3));
            const revenueData = appData.map(d => d.stats.revenue);
            const cashData = appData.map(d => d.stats.accumulated);
            const adsData = appData.map(d => d.stats.ads);
            const salaryData = appData.map(d => d.stats.salary);

            if (yearlyChartInstance) yearlyChartInstance.destroy();

            yearlyChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Faturamento Mensal',
                            data: revenueData,
                            backgroundColor: '#E2E8F0',
                            borderRadius: 4,
                            yAxisID: 'y', 
                            order: 2
                        },
                        {
                            label: 'Caixa Acumulado',
                            data: cashData,
                            type: 'line',
                            borderColor: '#059669', // Emerald
                            backgroundColor: '#059669',
                            borderWidth: 3,
                            pointRadius: 4,
                            pointBackgroundColor: '#fff',
                            pointBorderWidth: 2,
                            yAxisID: 'y', 
                            tension: 0.4,
                            order: 1
                        },
                        {
                            label: 'Invest. Tr√°fego (Eixo Dir.)',
                            data: adsData,
                            type: 'line',
                            borderColor: '#F59E0B', // Amber
                            borderWidth: 2,
                            pointRadius: 3,
                            pointBackgroundColor: '#fff',
                            yAxisID: 'y1', 
                            tension: 0.4,
                            order: 0
                        },
                        {
                            label: 'Pro-labore (Eixo Dir.)',
                            data: salaryData,
                            type: 'line',
                            borderColor: '#EF4444', // Red
                            borderDash: [2, 2],
                            borderWidth: 2,
                            pointRadius: 3,
                            yAxisID: 'y1', 
                            tension: 0.4,
                            order: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: { position: 'top', align: 'end', labels: { usePointStyle: true, boxWidth: 8, font: { size: 11 } } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            grid: { display: true, borderDash: [2, 4], color: '#f1f1f1' },
                            title: { display: true, text: 'Faturamento & Caixa', color: '#94a3b8', font: { size: 10 } },
                            ticks: { callback: (value) => 'R$ ' + value/1000 + 'k' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            grid: { drawOnChartArea: false }, 
                            title: { display: true, text: 'Investimento & Sal√°rio', color: '#f59e0b', font: { size: 10 } },
                            ticks: { callback: (value) => 'R$ ' + value/1000 + 'k', color: '#f59e0b' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
